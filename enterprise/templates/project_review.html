{% extends "project_base.html" %}
{% load i18n staticfiles project_filters%}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'vex/css/vex.css' %}">
    <link rel="stylesheet" href="{% static 'vex/css/vex-theme-os.css' %}">
    <link rel="stylesheet" href="{% static 'ladda/dist/ladda.min.css' %}">
{% endblock %}

{% block extra_js %}
    <script src="{% static 'ladda/dist/spin.min.js' %}"></script>
    <script src="{% static 'ladda/dist/ladda.min.js' %}"></script>
    <script src="{% static 'jspdf/dist/jspdf.min.js' %}"></script>
    <script src="{% static 'jquery-cookie/jquery.cookie.js' %}"></script>
    <script src="{% static 'vex/js/vex.combined.min.js' %}"></script>
    <script>vex.defaultOptions.className = 'vex-theme-os';</script>
    <script src="{% static 'jquery-file-upload/js/vendor/jquery.ui.widget.js' %}"></script>
    <script src="{% static 'jquery-file-upload/js/jquery.iframe-transport.js' %}"></script>
    <script src="{% static 'jquery-file-upload/js/jquery.fileupload.js' %}"></script>

    <script>
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    //Best to attach onclick event in jQuery ready() function like this
    $(document).ready(function(){
        var l = Ladda.create( document.querySelector( '#approve' ) );
        var csrf_token = $.cookie('csrftoken');

        $("#approve").click(function(){
            // Start loading
            l.start();
            l.setProgress( 0.5 );

{#            var csrf_token = $.cookie('csrftoken');#}
             $.post("{% url 'enterprise.review.approve' review.id%}",{project_id:"{{ review.id }}", csrfmiddlewaretoken:csrf_token},
                    function(data){
                        $("#approved").text("{% trans 'Approved' %}")
                        l.stop();
            })

        });

        $("#deny").click(function(){
            vex.dialog.prompt({
              message:"{% trans 'Please input reject reason:' %}",
              placeholder: "{% trans 'Reject Reason' %}",
              callback: function(value) {
                if (value === false) {
                  return console.log('Cancelled');
                }

                $.post("{% url 'enterprise.review.deny'  review.id%}",{ csrfmiddlewaretoken:csrf_token},
                        function(data){
                            $("#approved").text("{% trans 'Deny' %}")
                })
              }
            });
        });

        $('#fileupload').fileupload({
            crossDomain: false,
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type)) {
                    xhr.setRequestHeader("X-CSRFToken", csrf_token);
                }
            },
            dataType: 'json',
            done: function (e, data) {
                console.log(data);
{#                $.each(data.result.files, function (index, file) {#}
{#                    $('<p/>').text(file.name).appendTo(document.body);#}
{#                });#}
            },
            progressall: function (e, data) {
                var progress = parseInt(data.loaded / data.total * 100, 10);
                console.log(progress);
                $('#progress .progress-bar').css(
                    'width',
                    progress + '%'
                );
            }
        });
    });

    </script>
{% endblock %}

{% block left_panel %}
    {% include "review_left_panel.html" %}
{% endblock %}

{% block project_main %}
{% if review.id != 99999 %}
<div class="container">
    <label>{% trans "Project" %}</label><p>{{ review.project.name }}<br></p>
    <label>{% trans "Grade" %}</label><p>{{ review.grade }}<br></p>
    <label>{% trans "Approved" %}</label><p id="approved">{{ review.approved |approve_state}}<br></p>
<div>
<div>
    <a target="_blank" href="{{ MEDIA_URL }}/review/{{ review.id }}.pdf" class="btn btn-primary">{% trans "Preview" %}</a>
    <button id="approve" class="ladda-button" data-style="expand-right" data-size="s" data-color="blue"><span class="ladda-label">{% trans "Approve" %}</span></button>
    <a href="#" id="deny" class="btn btn-primary">{% trans "Deny" %}</a>
</div>
    <div>
        <input id="fileupload" type="file" name="files[]" data-url="{% url 'enterprise.review.photo' review.id%}" multiple>
    </div>
    <!-- The global progress bar -->
    <div id="progress" class="progress">
        <div class="progress-bar progress-bar-success"></div>
    </div>
{% endif %}
</div>
</div>
{% endblock %}