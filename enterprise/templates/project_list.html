{% extends "list_base.html" %}
{% load i18n staticfiles%}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'hint.css/hint.min.css' %}">
    <link rel="stylesheet" href="{% static 'jquery/jquery.qtip.min.css' %}">
    <link rel="stylesheet" href="{% static 'vex/css/vex.css' %}">
    <link rel="stylesheet" href="{% static 'vex/css/vex-theme-os.css' %}">
    <link rel="stylesheet" href="{% static 'datatables/media/css/jquery.dataTables.css' %}">
{% endblock %}

{% block extra_js %}
    <script src="{% static 'peity/jquery.peity.min.js' %}"></script>
    <script src="{% static 'jquery/jquery.qtip.min.js' %}"></script>
    <script src="{% static 'vex/js/vex.combined.min.js' %}"></script>
    <script>vex.defaultOptions.className = 'vex-theme-os';</script>
    <script src="{% static 'jquery-cookie/jquery.cookie.js' %}"></script>
    <script src="{% static 'datatables/media/js/jquery.dataTables.js' %}"></script>
    <script src="{% static 'chartjs/Chart.js' %}"></script>
    <script>
    $(document).ready(function(){
        //show table
        var table = $('#table').DataTable();
        var selected = [];

        $('#table tbody').on( 'click', 'tr', function () {
            $(this).toggleClass('selected');
            var id = $(this).data("rowKey");
            var index = $.inArray(id, selected);
            if ( index === -1 ) {
                selected.push( id );
            } else {
                selected.splice( index, 1 );
            }
            console.log(selected);
        } );


        $('.detail').each(function() {
{#             $(this).qtip({#}
{#                 content: {#}
{#                     text: $('.tooltiptext')#}
{#                 }#}
{#             });#}

            $(this).qtip({
            content: {
                text: function(event, api) {
                    $.ajax({
                        url: api.elements.target.attr('href') // Use href attribute as URL
                    })
                    .then(function(content) {
                        // Set the tooltip content upon successful retrieval
                        api.set('content.text', content);
                    }, function(xhr, status, error) {
                        // Upon failure... set the tooltip content to error
                        api.set('content.text', status + ': ' + error);
                    });

                    return 'Loading...'; // Set some initial text
                }
            },
            position: {
                viewport: $(window)
            },
            style: 'qtip-wiki'
         });

        $("span.pie").peity("pie");
         });

        $("#modify").click(function(){
            //a trick to pass JS variable to django url template tag
            var url = "{% url 'enterprise.project.update' pk=99999 %}";
            url = url.replace(/99999/, selected[0]);
            window.location.href = url;
{#            window.open("{% url "enterprise.project.update" pk=1 %}",'_parent'); //Also works            #}
        });

        $("#delete").click(function() {
            console.log("delete now");

            vex.dialog.confirm({
              message:"{% trans 'Are you sure to delete this project?' %}",
              callback: function(value) {
                if (value === false) {
                  return console.log('Cancelled');
                }
            var csrf_token = $.cookie('csrftoken');
            $.post("{% url 'enterprise.project.delete'%}",{project_id:"{{ submission.id }}", csrfmiddlewaretoken:csrf_token},
                    function(data){
                console.log(data);
            })
                return console.log('Username', data.code, 'Password', data.amount);
              }
            });
        });

        var ctx = $("#myChart1").get(0).getContext("2d");
        var data2 = {
    labels: ["申报创建", "应用评审", "总结报告", "影像资料", "评价表", "考评评选"],
    datasets: [
        {
            label: "My Second dataset",
            fillColor: "rgba(151,187,205,0.2)",
            strokeColor: "rgba(151,187,205,1)",
            pointColor: "rgba(151,187,205,1)",
            pointStrokeColor: "#fff",
            pointHighlightFill: "#fff",
            pointHighlightStroke: "rgba(151,187,205,1)",
            data: [100, 100, 100, 0, 0, 0]
        }
    ]
};
            var myLineChart = new Chart(ctx).Line(data2, {responsive:true});

        var ctx = $("#myChart2").get(0).getContext("2d");
        var myLineChart2 = new Chart(ctx).Line(data2, {responsive:true});

    });

    </script>
{% endblock %}

{% block toolbar %}
<div class="btn-group">
  <a href="{% url "enterprise.project.add" %}" class="btn btn-default">{% trans "Create" %}</a>
  <a id="modify" href="#" class="btn btn-default">{% trans "Modify" %}</a>
  <a id="delete" href="#" class="btn btn-default">{% trans "Delete" %}</a>
</div>
{% endblock %}

{% block list %}
<table id="table" class="display table table-bordered">
    <thead>
        <th>{% trans "Project" %}</th>
        <th>{% trans "Location" %}</th>
        <th>{% trans "Progress" %}</th>
    </thead>
    {% for p in projects %}
        <tr data-row-key="{{ p.id }}">
            <td><a href="{%  url 'enterprise.project.detail' p.id %}" class="hint--right" data-hint="{% trans 'Detail' %}">{{ p.name }}</a></td>
            <td>{{ p.location }}</td>
            <td>
                <canvas id="myChart{{ p.id }}"  width="100" height="30"></canvas>
            </td>
        </tr>
    {% endfor %}
</table>

{% endblock %}
